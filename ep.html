<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>CUBE EXPLORE CARD</title>
  <style>
    :root {
      --bg: #010409;
      --text: #fff;
      --cube-green: #d2f84a;
      --shadow: rgba(0,0,0,0.8);
      --dev-zoom: 100; /* ← Change this number only (90–130) for your private zoom */
    }
    * { margin:0; padding:0; box-sizing:border-box; touch-action: manipulation; }
    html, body { 
      height:100%; width:100%; overflow:hidden; background:var(--bg); color:var(--text);
      font-family:system-ui,sans-serif; zoom: calc(var(--dev-zoom) * 1%);
    }
    body { display:flex; justify-content:center; align-items:flex-start; }
    .container { width:100%; max-width:480px; height:100vh; padding:20px; text-align:center; overflow-y:auto; -webkit-overflow-scrolling:touch; }

    .title {
      font-size:25px; font-weight:900;
      background:linear-gradient(90deg,#00ff9d,#39ff14);
      -webkit-background-clip:text; -webkit-text-fill-color:transparent;
      margin:10px 0 6px;
    }
    .welcome { color:#fff; font-size:19px; margin:12px 0 20px; font-weight:600; }
    .welcome span { color:var(--cube-green); }

    .balance {
      display:flex; flex-direction:column; gap:10px; font-size:18px;
      background:#111; padding:14px 20px; border-radius:14px; border:2px solid #333;
      width:fit-content; margin:25px auto;
    }
    .item { display:flex; align-items:center; gap:8px; white-space:nowrap; }
    .label { font-weight:900; min-width:60px; }
    .value { display:flex; align-items:center; gap:4px; }
    #stars-count { color:#FFD700; }

    .marquee {
      overflow:hidden; white-space:nowrap; margin:30px 0;
      border-radius:18px; background:#111; padding:14px 0; border:2px solid #333;
    }
    .marquee-inner { display:inline-block; animation:marquee 40s linear infinite; }
    .marquee img {
      width:110px; height:110px; object-fit:cover; margin:0 20px;
      border-radius:16px; border:3px solid var(--cube-green);
      box-shadow:0 6px 20px rgba(0,255,157,0.3);
    }

    .pick-title {
      font-size:32px; font-weight:900; color:#fff; margin:50px 0 30px;
      letter-spacing:3px; text-transform:uppercase;
      font-family:'Arial Black', Impact, sans-serif;
    }

    .table-wrapper {
      background: url('https://cdn.shopify.com/s/files/1/0962/6648/6067/files/Untitled_design_1.jpg?v=1765639244') center/cover no-repeat;
      border-radius:24px; padding:30px 20px; margin:40px 0;
      box-shadow: inset 0 0 60px rgba(0,0,0,0.8); border:2px solid #111;
    }

  .cards-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 18px;
  perspective: 1200px;
  padding-bottom: 80px;
}

.card {
  width: 100%;
  /* height: 130px;         ← delete this */
  aspect-ratio: 4242 / 6000;   /* ← exact ratio of your real images */
  /* or use the simplified version below */
  aspect-ratio: 0.707 / 1;     /* same thing, just shorter to type */
  
  position: relative;
  transform-style: preserve-3d;
  cursor: pointer;
  border-radius: 20px;
  transition: transform 0.8s cubic-bezier(0.175,0.885,0.32,1.275);
}

.card:hover {
  transform: scale(1.07) translateY(-12px);
}

.card-face {
  position: absolute;
  inset: 0;
  backface-visibility: hidden;
  
  /* ← THIS is the fix for the “eaten edges” */
  border-radius: 4%;           /* use % instead of fixed px */
  overflow: hidden;            /* makes sure nothing ever bleeds out */
  
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;
}

.card-back {
  background: url('https://cdn.shopify.com/s/files/1/0962/6648/6067/files/epcard_back.png?v=1766106762') center/cover;
}

.card-front {
  background: url('https://cdn.shopify.com/s/files/1/0962/6648/6067/files/epcard_front.png?v=1766106736') center/cover;
  color: #fff;
  text-shadow: 2px 2px 10px #000;
  transform: rotateY(180deg);
}

.card.flipped { transform: rotateY(180deg); }
.card.locked  { opacity: 0.6; cursor: not-allowed; pointer-events: none; }

    .phone-modal, .final-modal {
      position:fixed; inset:0; background:rgba(0,0,0,0.96); display:none;
      align-items:center; justify-content:center; z-index:999;
    }
    .phone-modal.active, .final-modal.active { display:flex; }
    .phone-content, .final-content {
      background:#111; padding:32px; border-radius:20px; width:90%; max-width:380px;
      border:3px solid var(--cube-green); text-align:center; position:relative;
    }
    .phone-close, .final-close { position:absolute; top:12px; right:12px; color:#888; font-size:28px; cursor:pointer; }
    .phone-input { width:100%; padding:18px; margin:20px 0; background:#222; border:none; border-radius:14px; color:#fff; font-size:17px; }
    .btn-confirm { background:var(--cube-green); color:#000; border:none; padding:18px; border-radius:14px; font-weight:900; font-size:19px; cursor:pointer; }

    .spinner { position:fixed; inset:0; background:rgba(0,0,0,0.98); display:none; align-items:center; justify-content:center; z-index:9999; }
    .spinner.active { display:flex; }
    .spinner::after { content:""; width:70px; height:70px; border:7px solid #222; border-top:7px solid var(--cube-green); border-radius:50%; animation:spin 1s linear infinite; }

    @keyframes marquee { 0% { transform:translateX(0); } 100% { transform:translateX(-50%); } }
    @keyframes spin { to { transform:rotate(360deg); } }
    .vip-tease {
  color: #888;
  font-size: 16px;
  font-weight: 500;
  margin: -20px 0 50px;
  line-height: 1.5;
  opacity: 0.9;
}
.vip-tease span {
  color: var(--cube-green);
  font-weight: 700;
}
.mobile-br { display:none; }
@media (max-width: 420px) { .mobile-br { display:block; } }
.sip-logo {
  display: block;
  margin: 0 auto 9px auto; /* center and add spacing below */
  max-width: 190px;          /* adjust size as needed */
  height: auto;
}
.title {
  display: none;
}
  </style>
</head>
<body>
 <div class="container">
    <!-- Logo above SIP PICKER -->
    <img src="https://cdn.shopify.com/s/files/1/0962/6648/6067/files/HABA_HOUSE.png?v=1765412962" 
         alt="HabaHouse Logo" 
         class="sip-logo">

    <div class="title">EXPLORE CARD</div>
    <div class="welcome" id="welcomeMsg">
      Welcome <span id="username">Guest</span>, you're on <span id="hostName">no one</span>'s VIP!
    </div>
   
    <div class="balance">
      <div class="item"><span class="label">STRZ BALANCE:</span> <span class="value"><span id="stars-count">0</span> ⭐️</span></div>
      <div class="item"><span class="label">CASH BALANCE:</span> <span class="value">₦<span id="cash-count">0</span></span></div>
    </div>

    <div class="marquee"><div class="marquee-inner" id="marquee"></div></div>

  <h2 class="pick-title">PICK A CARD</h2>

<p class="vip-tease">
  You’ve joined <span id="referral"> her</span> to party — pick a card & unlock this location with her!
  get ready for more action,<br class="mobile-br">
  this party's just got real interesting.
</p>

<div class="table-wrapper">
  <div class="cards-grid" id="cards-grid"></div>
</div>

  <!-- Modals -->
  <div class="phone-modal" id="phoneModal">
    <div class="phone-content">
      <span class="phone-close" id="phoneClose">×</span>
      <h2 style="color:var(--cube-green);">Enter Delivery Phone Number</h2>
      <p style="color:#888;margin:15px 0 25px;font-size:15px;">We'll text/call this number to deliver your drink</p>
      <input type="tel" id="phoneInput" class="phone-input" placeholder="+234 801 234 5678">
      <button class="btn-confirm" id="phoneConfirm">CONFIRM & PICK</button>
    </div>
  </div>

  <div class="final-modal" id="finalModal">
    <div class="final-content">
      <span class="final-close" id="finalClose">×</span>
      <h2 style="color:var(--cube-green);">Congratulations!</h2>
      <p style="color:#fff;margin:25px 0;font-size:18px;" id="finalMessage"></p>
    </div>
  </div>

  <div class="spinner" id="spinner"></div>

  <!-- Confetti -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
  <script>
    const soundTap = new Audio("https://example.com/tap.mp3");
    const soundWin = new Audio("https://example.com/win.mp3");
    const playTap = () => { soundTap.currentTime = 0; soundTap.play().catch(()=>{}); };
    const playWin = () => { soundWin.currentTime = 0; soundWin.play().catch(()=>{}); };

    const fireConfetti = () => {
      const colors = ['#ff6b6b','#4ecdc4','#45b7d1','#f9ca24','#f3722c','#a29bfe','#fd79a8','#00ff9d'];
      const end = Date.now() + 3500;
      (function f() { confetti({particleCount:7, spread:70, origin:{y:0.6}, colors}); if (Date.now() < end) requestAnimationFrame(f); })();
    };
  </script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getFirestore, doc, getDoc, onSnapshot, runTransaction, serverTimestamp, addDoc, collection } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const app = initializeApp({
    apiKey: "AIzaSyD_GjkTox5tum9o4AupO0LeWzjTocJg8RI",
    authDomain: "dettyverse.firebaseapp.com",
    projectId: "dettyverse",
    storageBucket: "dettyverse.firebasestorage.app",
    messagingSenderId: "1036459652488",
    appId: "1:1036459652488:web:e8910172ed16e9cac9b63d"
  });
  const db = getFirestore(app);

  let currentUser = null;
  const COST = 100;

  const drinks = ["Hennessy Paradise","Cîroc Coconut","Don Julio 1942","Moët Ice","Ace of Spades","Jack Daniel’s","Martell Blue Swift","Remy Martin XO","Grey Goose","Patrón Silver","Casamigos Blanco","1800 Coconut","D’ussé VSOP","Belvedere","Cristal","Dom Pérignon","Johnnie Walker Blue","Macallan 18","Heineken","Guinness","Red Bull","Tequila Rose","Blue Nun","Veuve Clicquot"];

  const DOM = {
    username: document.getElementById('username'),
    hostName: document.getElementById('hostName'),
    referral: document.getElementById('referral'),
    stars: document.getElementById('stars-count'),
    cash: document.getElementById('cash-count'),
    cardsGrid: document.getElementById('cards-grid'),
    marquee: document.getElementById('marquee'),
    phoneModal: document.getElementById('phoneModal'),
    phoneInput: document.getElementById('phoneInput'),
    phoneConfirm: document.getElementById('phoneConfirm'),
    phoneClose: document.getElementById('phoneClose'),
    finalModal: document.getElementById('finalModal'),
    finalMessage: document.getElementById('finalMessage'),
    finalClose: document.getElementById('finalClose'),
    spinner: document.getElementById('spinner')
  };

  const showSpinner = () => DOM.spinner.classList.add('active');
  const hideSpinner = () => DOM.spinner.classList.remove('active');
  const finalModal = msg => { DOM.finalMessage.innerHTML = msg; DOM.finalModal.classList.add('active'); };

  const emailToDocId = email => email?.includes('@') ? `${email.toLowerCase().split('@')[0]}_${email.split('@')[1].replace(/\./g,'_')}` : null;

  // AUTO LOGIN + FULL USER LOAD (exactly like your original)
  const loadCurrentUser = async () => {
    showSpinner();
    try {
      const stored = JSON.parse(localStorage.getItem('vipUser') || localStorage.getItem('hostUser') || '{}');
      if (!stored?.email) return hideSpinner();

      const uid = emailToDocId(stored.email);
      if (!uid) return hideSpinner();

      const userRef = doc(db, 'users', uid);
      const snap = await getDoc(userRef);

      if (!snap.exists()) {
        currentUser = { uid, stars: 0, cash: 0, email: stored.email };
        DOM.username.textContent = stored.email.split('@')[0];
        hideSpinner();
        return;
      }

      const data = snap.data();
      currentUser = { uid, ...data, email: stored.email };

      DOM.username.textContent = currentUser.chatId || stored.email.split('@')[0];
      const host = currentUser.hostName || currentUser.referral || 'someone';
      DOM.hostName.textContent = host.startsWith('@') ? host.slice(1) : host;

      DOM.stars.textContent = (currentUser.stars || 0).toLocaleString();
      DOM.cash.textContent = (currentUser.cash || 0).toLocaleString();

      onSnapshot(userRef, snap => {
        if (!snap.exists()) return;
        const d = snap.data();
        currentUser = { uid, ...d };
        DOM.stars.textContent = (d.stars || 0).toLocaleString();
        DOM.cash.textContent = (d.cash || 0).toLocaleString();
      });

    } catch (e) { console.error(e); }
    finally { hideSpinner(); }
  };

  // MARQUEE – FIXED & WORKING
  const initMarquee = () => {
    const links = [
      "https://cdn.shopify.com/s/files/1/0962/6648/6067/files/47.png?v=1764928903",
      "https://cdn.shopify.com/s/files/1/0962/6648/6067/files/46.png?v=1764928904",
      "https://cdn.shopify.com/s/files/1/0962/6648/6067/files/36.png?v=1764928903",
      "https://cdn.shopify.com/s/files/1/0962/6648/6067/files/42.png?v=1764928903",
      "https://cdn.shopify.com/s/files/1/0962/6648/6067/files/48.png?v=1764928903",
      "https://cdn.shopify.com/s/files/1/0962/6648/6067/files/40.png?v=1764928903"
    ];
    links.forEach(src => {
      const img = document.createElement('img');
      img.src = src;
      DOM.marquee.appendChild(img);
    });
    DOM.marquee.innerHTML += DOM.marquee.innerHTML; // seamless loop
  };

  const initCards = () => {
    const shuffled = [...drinks].sort(() => Math.random() - 0.5);
    const numbers = Array.from({length:24},(_,i)=>i+1).sort(()=>Math.random()-0.5);
    DOM.cardsGrid.innerHTML = '';
    shuffled.forEach((drink, i) => {
      const card = document.createElement('div');
      card.className = 'card';
      card.dataset.drink = drink;
      card.dataset.number = numbers[i];
      card.innerHTML = `<div class="card-face card-back"></div><div class="card-face card-front">${drink}</div>`;
      card.onclick = () => {
        if (card.classList.contains('flipped')) return;
        playTap();
        card.classList.add('flipped'); // instant flip
        pickCard(card);
      };
      DOM.cardsGrid.appendChild(card);
    });
  };

const pickCard = async (card) => {
  if (!currentUser || currentUser.stars < COST) { 
    card.classList.remove('flipped'); 
    return finalModal(`You need ${COST} Stars`); 
  }
  if (!currentUser.invitedBy && !currentUser.hostName) { 
    card.classList.remove('flipped'); 
    return phoneModal("Invalid access"); 
  }

  DOM.phoneModal.classList.add('active');
  DOM.phoneConfirm.onclick = async () => {
    const phone = DOM.phoneInput.value.trim();
    if (!phone || phone.length < 10) return phoneModal('Invalid phone');
    
    DOM.phoneModal.classList.remove('active'); 
    DOM.phoneInput.value = ''; 
    showSpinner();

    try {
      const uid = emailToDocId(currentUser.email);
      const userRef = doc(db, 'users', uid);

      await runTransaction(db, async t => {
        const snap = await t.get(userRef);
        if (!snap.exists() || snap.data().stars < COST) throw "No stars";
        t.update(userRef, { stars: snap.data().stars - COST });
      });

      // Save drink request
      await addDoc(collection(db, 'drinkRequests'), {
        userId: uid,
        userEmail: currentUser.email,
        username: currentUser.chatId || currentUser.email.split('@')[0],
        invitedBy: currentUser.invitedBy || currentUser.referral,
        drink: card.dataset.drink,
        phone,
        cardNumber: Number(card.dataset.number),
        timestamp: serverTimestamp(),
        status: 'pending',
        delivered: false
      });

      // SEND NOTIFICATION TO USER — THIS IS THE KEY
     await addDoc(collection(db, "notifications"), {
  recipientId: uid,            // must match loadNotifications() query
  type: "drink_unlock",
  title: "Drink Unlocked!",
  message: `You just unlocked a ${card.dataset.drink}!\nWe'll deliver it to ${phone} soon.\nThank you for playing!`,
  read: false,
  icon: "drink",
  createdAt: serverTimestamp(), // used for timeAgo() and ordering
  data: {
    drink: card.dataset.drink,
    phone: phone,
    cardNumber: card.dataset.number
  }
});

      card.classList.add('locked');
      DOM.finalMessage.innerHTML = `
        You picked card <strong>#${card.dataset.number}</strong><br>
        Drink: <strong>${card.dataset.drink}</strong><br><br>
        We'll deliver to:<br><strong>${phone}</strong>
      `;
      DOM.finalModal.classList.add('active');
      fireConfetti(); 
      playWin();

      currentUser.stars -= COST;
      DOM.stars.textContent = currentUser.stars.toLocaleString();

    } catch(e) {
      console.error("Drink unlock failed:", e);
      card.classList.remove('flipped');
      finalModal('Failed. Try again.');
    } finally { 
      hideSpinner(); 
    }
  };

  DOM.phoneClose.onclick = () => { 
    DOM.phoneModal.classList.remove('active'); 
    document.querySelectorAll('.card.flipped:not(.locked)').forEach(c => c.classList.remove('flipped')); 
  };
  DOM.finalClose.onclick = () => DOM.finalModal.classList.remove('active');
};
  // INIT EVERYTHING
  loadCurrentUser();
  initMarquee();
  initCards();
</script>
</body>
</html>
